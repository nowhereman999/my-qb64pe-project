# .github/workflows/compile-bas-windows.yml
name: Compile QB64-PE (Windows x64)

on:
  push:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  pull_request:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  workflow_dispatch:
    inputs:
      bas_paths:
        description: 'Comma-separated .bas file paths (relative to repo root)'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-2022
    env:
      QB64PE_DIR: ${{ github.workspace }}\tools\qb64pe_Windows_x64
      ARTIFACT_DIR: ${{ github.workspace }}\artifacts
      CI: "1"
      SDL_VIDEODRIVER: dummy
      SDL_AUDIODRIVER: dummy
      SDL_RENDER_DRIVER: software

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify QB64-PE Windows setup
        shell: pwsh
        run: |
          if (-not (Test-Path "$env:QB64PE_DIR\qb64pe.exe")) {
            Write-Error "qb64pe.exe missing! Commit tools/qb64pe_Windows_x64/ from your working machine."
            exit 1
          }
          if (-not (Test-Path "$env:QB64PE_DIR\internal")) {
            Write-Error "internal/ folder missing next to qb64pe.exe!"
            exit 1
          }
          Write-Output "QB64-PE Windows setup verified."

      - name: Compile selected .bas files
        id: compile
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "$env:ARTIFACT_DIR" | Out-Null

          # Build the list of files
          if ("${{ inputs.bas_paths }}" -ne "") {
            $filesRel = "${{ inputs.bas_paths }}".Split(",") | ForEach-Object { $_.Trim() } | Where-Object { $_ }
            $files = $filesRel | ForEach-Object { Join-Path $env:GITHUB_WORKSPACE $_ }
          } else {
            $root = Join-Path $env:GITHUB_WORKSPACE 'BASIC-To-6809_Source_Code'
            $files = Get-ChildItem -Path $root -File -Filter *.bas | ForEach-Object { $_.FullName }
            $sd1 = Join-Path $root 'IDE\SDECB.bas'
            $sd2 = Join-Path $root 'IDE\SDECB.BAS'
            if (Test-Path $sd1) { $files += $sd1 }
            elseif (Test-Path $sd2) { $files += $sd2 }
          }

          # De-duplicate and validate
          $files = $files | Sort-Object -Unique
          if ($files.Count -eq 0) {
            "executables=" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "compiled_count=0" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          Write-Output "Compiling $($files.Count) file(s):"
          $files | ForEach-Object { Write-Output " - $($_.Substring($env:GITHUB_WORKSPACE.Length + 1))" }

          $executables = New-Object System.Collections.Generic.List[string]
          $count = 0

          foreach ($abs in $files) {
            if (-not ($abs -match '\.[bB][aA][sS]$')) { continue }
            $base = [System.IO.Path]::GetFileNameWithoutExtension($abs)
            $outName = "$base.exe"                                    # output name only (no path)
            $outAbs  = Join-Path $env:ARTIFACT_DIR $outName            # final destination

            Write-Output "Compiling: $(Split-Path $abs -Leaf) â†’ $outName"

            # Always run qb64pe from its own directory so .\internal\temp exists there
            Push-Location $env:QB64PE_DIR

            # Capture stdout/stderr so we have *some* diagnostics even if compilelog.txt isn't created
            $cmd = ".\qb64pe.exe -x `"$abs`" -o `"$outName`""
            Write-Output ">> $cmd"
            $compileOutput = & cmd /c $cmd 2>&1
            $code = $LASTEXITCODE
            if ($compileOutput) { $compileOutput | Out-Host }

            Pop-Location

            if ($code -ne 0) {
              Write-Output "=== COMPILATION ERROR ($base) ==="

              # Dump any logs QB64PE may have written
              $logRoot = Join-Path $env:QB64PE_DIR 'internal\temp'
              if (Test-Path $logRoot) {
                Write-Output "-- internal\\temp listing --"
                Get-ChildItem -Path $logRoot -Recurse -File | Select-Object FullName, Length, LastWriteTime | Format-Table | Out-String | Write-Output
                Write-Output "-- *.txt contents (if small) --"
                Get-ChildItem -Path $logRoot -Recurse -File -Filter *.txt | ForEach-Object {
                  Write-Output "----- $($_.FullName) -----"
                  try { Get-Content $_.FullName | Write-Output } catch { Write-Output "(could not read)" }
                }
              } else {
                Write-Output "(no internal\\temp directory yet)"
              }

              Write-Output "================================"
              exit 1
            }

            # Copy result from QB64PE_DIR to artifacts
            Copy-Item (Join-Path $env:QB64PE_DIR $outName) $outAbs -Force
            Remove-Item (Join-Path $env:QB64PE_DIR $outName) -ErrorAction SilentlyContinue

            $executables.Add($outName) | Out-Null
            $count++
          }

          "executables=$($executables -join ' ')" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "compiled_count=$count"                  | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Create zip archive
        if: ${{ steps.compile.outputs.compiled_count != '0' }}
        shell: pwsh
        run: |
          Compress-Archive -Path "$env:ARTIFACT_DIR\*.exe" -DestinationPath qb64pe_Windows_x64_executables.zip -Force

      - name: Upload artifact
        if: ${{ steps.compile.outputs.compiled_count != '0' }}
        uses: actions/upload-artifact@v4
        with:
          name: qb64pe-windows-x64-executables
          path: qb64pe_Windows_x64_executables.zip
          retention-days: 30

      - name: Job summary
        if: success()
        shell: pwsh
        env:
          EXEC_LIST: ${{ steps.compile.outputs.executables }}
          COUNT: ${{ steps.compile.outputs.compiled_count }}
        run: |
          @"
          ## QB64-PE Windows x64 Build Complete

          Compiled $env:COUNT program(s):

          $($env:EXEC_LIST -split ' ' | ForEach-Object { "- $_" } | Out-String)

          Download **qb64pe_Windows_x64_executables.zip** from **Artifacts**  
          *Native 64-bit Windows .exe files (no dependencies)*
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8