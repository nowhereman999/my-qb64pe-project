name: Compile QB64-PE (Windows x64)

on:
  push:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  pull_request:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  workflow_dispatch:
    inputs:
      bas_paths:
        description: 'Comma-separated .bas file paths (relative to repo root)'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-2022
    env:
      QB64PE: ${{ github.workspace }}\tools\qb64pe_Windows_x64\qb64pe.exe
      ARTIFACTS: ${{ github.workspace }}\artifacts
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install MinGW
        shell: cmd
        run: choco install mingw -y --no-progress

      - name: Add MinGW to PATH
        shell: cmd
        run: |
          for %%p in (
            "C:\tools\mingw64\bin"
            "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin"
            "C:\mingw64\bin"
          ) do if exist %%p (
            set "PATH=%%p;%PATH%"
            echo %%p>> "%GITHUB_PATH%"
          )
          gcc --version

      - name: Verify QB64-PE
        shell: cmd
        run: |
          if not exist "%QB64PE%" (
            echo qb64pe.exe missing! Commit tools/qb64pe_Windows_x64/
            exit 1
          )
          echo QB64-PE found.

      - name: Override internal compiler
        shell: cmd
        run: |
          set "INTERNAL=%~dp0tools\qb64pe_Windows_x64\internal\c\c_compiler"
          rmdir /s /q "%INTERNAL%" 2>nul
          mkdir "%INTERNAL%\bin" >nul
          for /f "delims=" %%G in ('where gcc.exe') do set "GCC=%%G"
          for /f "delims=" %%X in ('where g++.exe') do set "GPP=%%X"
          for /f "delims=" %%M in ('where make.exe') do set "MAKE=%%M"
          (
            echo @echo off
            echo "%GCC%" %%*
          ) > "%INTERNAL%\bin\gcc.exe"
          (
            echo @echo off
            echo "%GPP%" %%*
          ) > "%INTERNAL%\bin\g++.exe"
          (
            echo @echo off
            echo "%MAKE%" %%*
          ) > "%INTERNAL%\bin\make.exe"
          copy "%MAKE%" "%INTERNAL%\bin\mingw32-make.exe" /y >nul
          set "BINDIR=%GCC:~0,-8%"
          for %%D in (libgcc_s_seh-1.dll libstdc++-6.dll libwinpthread-1.dll) do (
            if exist "%BINDIR%%%D" copy "%BINDIR%%%D" "%INTERNAL%\bin\" /y >nul
          )
          echo Compiler override complete.

      - name: Create artifacts folder
        shell: cmd
        run: mkdir "%ARTIFACTS%" >nul

      - name: Compile all .bas files (pure CMD - FIXED)
        id: compile
        shell: cmd
        run: |
          set "ROOT=%GITHUB_WORKSPACE%\BASIC-To-6809_Source_Code"
          set "EXE_LIST="
          set "COUNT=0"

          rem Use a temp file for deduplication (fixes delayed expansion bug)
          set "SEEN=%TEMP%\qb64pe_seen.txt"
          if exist "%SEEN%" del "%SEEN%"

          if defined INPUT_BAS_PATHS (
            for %%F in (%INPUT_BAS_PATHS%) do call :compile_one "%%F"
            goto :done
          )

          for /r "%ROOT%" %%F in (*.bas *.BAS) do call :compile_one "%%F"
          for %%F in ("%ROOT%\IDE\SDECB.bas" "%ROOT%\IDE\SDECB.BAS") do (
            if exist "%%F" call :compile_one "%%F"
          )

          :done
          if exist "%SEEN%" del "%SEEN%"
          echo executables=%EXE_LIST:~1%>> "%GITHUB_OUTPUT%"
          echo compiled_count=%COUNT%>> "%GITHUB_OUTPUT%"
          exit /b

          :compile_one
          set "FULL=%~f1"
          set "DIR=%~dp1"
          set "FILE=%~nx1"
          set "BASE=%~n1"

          rem Skip if already compiled (using temp file)
          if exist "%SEEN%" findstr /i "^%FULL%$"< "%SEEN%" >nul && exit /b
          echo %FULL%>> "%SEEN%"

          pushd "%DIR%"
          echo Compiling %FILE% -^> %BASE%.exe
          call "%QB64PE%" -x "%FILE%" -o "%BASE%.exe"
          if errorlevel 1 (
            echo === COMPILATION ERROR in %FILE% ===
            if exist "%~dp0tools\qb64pe_Windows_x64\internal\temp\compilelog.txt" (
              type "%~dp0tools\qb64pe_Windows_x64\internal\temp\compilelog.txt"
            )
            popd
            exit /b 1
          )
          copy "%BASE%.exe" "%ARTIFACTS%\%BASE%.exe" /y >nul
          del "%BASE%.exe" 2>nul
          set "EXE_LIST=%EXE_LIST% %BASE%.exe"
          set /a COUNT+=1
          popd
          exit /b

      - name: Create zip archive
        if: steps.compile.outputs.compiled_count > 0
        shell: cmd
        run: powershell -Command "Compress-Archive -Path '%ARTIFACTS%\*.exe' -DestinationPath qb64pe_Windows_x64_executables.zip -Force"

      - name: Upload artifact
        if: steps.compile.outputs.compiled_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: qb64pe-windows-x64-executables
          path: qb64pe_Windows_x64_executables.zip
          retention-days: 30

      - name: Job summary
        if: success() && steps.compile.outputs.compiled_count > 0
        shell: cmd
        run: |
          echo ## QB64-PE Windows x64 Build Complete>> "%GITHUB_STEP_SUMMARY%"
          echo.>> "%GITHUB_STEP_SUMMARY%"
          echo Compiled **${{ steps.compile.outputs.compiled_count }}** program(s):>> "%GITHUB_STEP_SUMMARY%"
          echo.>> "%GITHUB_STEP_SUMMARY%"
          for %%E in (${{ steps.compile.outputs.executables }}) do echo - `%%E`>> "%GITHUB_STEP_SUMMARY%"
          echo.>> "%GITHUB_STEP_SUMMARY%"
          echo Download **qb64pe_Windows_x64_executables.zip** from Artifacts>> "%GITHUB_STEP_SUMMARY%"
          echo *Native 64-bit Windows .exe files (no dependencies)*>> "%GITHUB_STEP_SUMMARY%"