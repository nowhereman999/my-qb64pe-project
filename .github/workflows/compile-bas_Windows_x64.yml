name: Compile BasTo6809 on Windows (Debug)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-2022

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Compile the QB64-PE program and display log
      id: compile_qb64_debug
      shell: powershell
      # Use 'continue-on-error' so the workflow proceeds to display the log, 
      # but we will manually check the outcome later.
      continue-on-error: true 
      run: |
        $toolsDir = ".\tools\qb64pe_Windows_x64"
        $sourceFile = "..\BASIC-To-6809_Source_Code\BasTo6809.bas"
        $exeName = "qb64pe.exe"
        $logPathRelative = ".\internal\temp\compilelog.txt"

        # Change the current directory to the tools directory
        Set-Location -Path $toolsDir
        Write-Host "Compiling from CWD: $(Get-Location)"

        # Execute the compiler
        & ".\$exeName" -x $sourceFile

        # Change directory back to the repository root for artifact handling
        Set-Location -Path (Get-Item WsDir).FullName 

        # Display the log file content regardless of error outcome
        $logPathAbsolute = Join-Path $toolsDir $logPathRelative
        if (Test-Path $logPathAbsolute) {
            Write-Host "--- Start of compilelog.txt (Absolute Path: $logPathAbsolute) ---"
            Get-Content $logPathAbsolute
            Write-Host "--- End of compilelog.txt ---"
        } else {
            Write-Host "ERROR: compilelog.txt not found at $logPathAbsolute"
            exit 1 # Fail the job if log isn't even created
        }

    # Stop the workflow here if the compilation step failed (exit code 1)
    - name: Check compilation status
      if: steps.compile_qb64_debug.outcome == 'failure'
      run: |
        echo "Compilation failed. Check the 'Compile the QB64-PE program and display log' step output for C++ errors."
        exit 1

    # The steps below only run if the above check passes (i.e. if the compilation succeeded)
    - name: Locate and upload compiled artifact
      id: find_artifact
      shell: powershell
      run: |
        $outputName = "BasTo6809.exe"
        $toolsDir = ".\tools\qb64pe_Windows_x64"
        # Since we changed back to the root dir above, this path is correct again
        $compiledPath = Join-Path $toolsDir $outputName

        if (Test-Path $compiledPath) {
            $absolutePath = (Get-Item $compiledPath).FullName
            echo "Found compiled executable at $absolutePath"
            echo "::set-output name=artifact_path::$absolutePath"
        } else {
            Write-Host "Could not find the compiled executable $outputName."
            exit 1 
        }

    - name: Upload compiled executable as artifact
      uses: actions/upload-artifact@v4
      with:
        name: BasTo6809-Windows-x64
        path: ${{ steps.find_artifact.outputs.artifact_path }}
