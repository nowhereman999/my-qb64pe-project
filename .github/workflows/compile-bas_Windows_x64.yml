name: Compile BasTo6809 on Windows

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Add QB64-PE compiler binaries to PATH
      # This step makes the MinGW/GCC executables available to all subsequent steps.
      run: |
        $compilerPath = Join-Path (Get-Location) "tools\qb64pe_Windows_x64\internal\c\c_compiler\bin"
        echo "Adding $compilerPath to PATH"
        # Append the path to the GITHUB_PATH environment file
        echo "$compilerPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: powershell

    - name: Compile the QB64-PE program
      id: compile_qb64
      # Removed continue-on-error: true here. If this fails, the job stops, 
      # but we rely on the error message (and potentially the log file) 
      # to diagnose issues.
      run: |
        $exePath = ".\tools\qb64pe_Windows_x64\qb64pe.exe"
        $sourceFile = ".\BASIC-To-6809_Source_Code\BasTo6809.bas"
        
        # Now qb64pe.exe can find gcc.exe because the directory is in the PATH
        & $exePath -x $sourceFile
      shell: powershell

    - name: Locate and upload compiled artifact
      # This step only runs if the compilation (previous step) was successful
      if: success()
      run: |
        $outputName = "BasTo6809.exe"
        # Check current working directory for output first
        $compiledPath = Join-Path (Get-Location) $outputName
        
        if (Test-Path $compiledPath) {
          Write-Host "Found compiled executable at $compiledPath"
        } else {
          # If not found in root, check in the tools directory (common QB64 output location)
          $toolsPath = Join-Path (Get-Location) "tools\qb64pe_Windows_x64"
          $compiledPath = Join-Path $toolsPath $outputName

          if (Test-Path $compiledPath) {
             Write-Host "Found compiled executable at $compiledPath"
          } else {
             Write-Host "Could not find the compiled executable $outputName."
             exit 1 
          }
        }
        
        echo "::set-output name=artifact_path::$compiledPath"
      shell: powershell
      id: find_artifact

    - name: Upload compiled executable as artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: BasTo6809-Windows-x64
        path: ${{ steps.find_artifact.outputs.artifact_path }}
