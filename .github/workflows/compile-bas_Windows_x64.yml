name: Compile QB64-PE (Windows x64)

on:
  push:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  pull_request:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  workflow_dispatch:
    inputs:
      bas_paths:
        description: 'Comma-separated .bas file paths (relative to repo root)'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-2022
    env:
      QB64PE_DIR: ${{ github.workspace }}\tools\qb64pe_Windows_x64
      ARTIFACT_DIR: ${{ github.workspace }}\artifacts
      CI: "1"
      SDL_VIDEODRIVER: dummy
      SDL_AUDIODRIVER: dummy
      SDL_RENDER_DRIVER: software

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify QB64-PE setup
        shell: pwsh
        run: |
          if (-not (Test-Path "$env:QB64PE_DIR\qb64pe.exe")) {
            Write-Error "qb64pe.exe missing! Commit tools/qb64pe_Windows_x64/ from your machine."; exit 1
          }
          if (-not (Test-Path "$env:QB64PE_DIR\internal")) {
            Write-Error "internal/ folder missing next to qb64pe.exe!"; exit 1
          }
          "QB64-PE Windows toolchain found."

      # ðŸ”§ Relaxed, auto-detecting version of the PATH step
      - name: (Optional) Add internal MinGW to PATH & show versions
        shell: pwsh
        run: |
          $root = Join-Path $env:QB64PE_DIR 'internal'
          $gcc  = Get-ChildItem -Path $root -Recurse -File -Filter gcc.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($gcc) {
            $bin = Split-Path $gcc.FullName -Parent
            $bin | Out-File -Append -FilePath $env:GITHUB_PATH
            "Using internal toolchain at: $bin"
            try { & "$bin\gcc.exe" --version } catch {}
            $mk = Get-ChildItem -Path $bin -File -Include mingw32-make.exe,make.exe -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($mk) { try { & $mk.FullName --version } catch {} }
          } else {
            "No internal gcc.exe found under: $root"
            "Proceeding anyway; qb64pe.exe can still invoke its bundled toolchain."
          }

      - name: Compile selected .bas files
        id: compile
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path "$env:ARTIFACT_DIR" | Out-Null

          # Build input list (explicit input > auto-discovery)
          $basInput = '${{ inputs.bas_paths }}'
          if ($basInput -and $basInput.Trim()) {
            $files = $basInput.Split(',') |
              ForEach-Object { $_.Trim() } |
              Where-Object { $_ } |
              ForEach-Object { Join-Path $env:GITHUB_WORKSPACE $_ }
          } else {
            $root = Join-Path $env:GITHUB_WORKSPACE 'BASIC-To-6809_Source_Code'
            $files = Get-ChildItem -Path $root -File -Recurse -Include *.bas,*.BAS | Select-Object -Expand FullName
            $sd1 = Join-Path $root 'IDE\SDECB.bas'
            $sd2 = Join-Path $root 'IDE\SDECB.BAS'
            if (Test-Path $sd1) { $files += $sd1 } elseif (Test-Path $sd2) { $files += $sd2 }
          }

          $files = $files | Sort-Object -Unique
          if (-not $files -or $files.Count -eq 0) {
            "executables="     | Out-File -Append -FilePath $env:GITHUB_OUTPUT
            "compiled_count=0" | Out-File -Append -FilePath $env:GITHUB_OUTPUT
            exit 0
          }

          "Compiling $($files.Count) file(s):"
          $files | ForEach-Object { " - $($_.Substring($env:GITHUB_WORKSPACE.Length + 1))" }

          $executables = New-Object System.Collections.Generic.List[string]
          $count = 0

          foreach ($abs in $files) {
            if (-not ($abs -match '\.[bB][aA][sS]$')) { continue }
            $base    = [System.IO.Path]::GetFileNameWithoutExtension($abs)
            $outName = "$base.exe"  # emit into QB64PE_DIR; copy out after

            Write-Output "Compiling: $(Split-Path $abs -Leaf) â†’ $outName"

            Push-Location $env:QB64PE_DIR
            $cmd = ".\qb64pe.exe -x `"$abs`" -o `"$outName`""
            Write-Output ">> $cmd"
            $compileOut = & cmd /c $cmd 2>&1
            $code = $LASTEXITCODE
            if ($compileOut) { $compileOut | Out-Host }
            Pop-Location

            if ($code -ne 0) {
              Write-Output "=== COMPILATION ERROR: $base ==="
              $log  = Join-Path $env:QB64PE_DIR 'internal\temp\compilelog.txt'
              if (Test-Path $log) {
                Write-Output "--- compilelog.txt (full) ---"
                try { Get-Content -Raw $log | Write-Output } catch { Write-Output "(could not read compilelog.txt)" }
              } else {
                Write-Output "(compilelog.txt not found)"
              }
              $logRoot = Join-Path $env:QB64PE_DIR 'internal\temp'
              if (Test-Path $logRoot) {
                Get-ChildItem -Path $logRoot -Recurse -File -Filter *.txt | Where-Object { $_.FullName -ne $log } | ForEach-Object {
                  Write-Output "----- $($_.FullName) -----"
                  try { Get-Content $_.FullName | Write-Output } catch { Write-Output "(could not read)" }
                }
              }
              Write-Output "================================"
              exit 1
            }

            Copy-Item (Join-Path $env:QB64PE_DIR $outName) (Join-Path $env:ARTIFACT_DIR $outName) -Force
            Remove-Item (Join-Path $env:QB64PE_DIR $outName) -ErrorAction SilentlyContinue
            $executables.Add($outName) | Out-Null
            $count++
          }

          "executables=$($executables -join ' ')" | Out-File -Append -FilePath $env:GITHUB_OUTPUT
          "compiled_count=$count"                 | Out-File -Append -FilePath $env:GITHUB_OUTPUT

      - name: Create zip archive
        if: ${{ steps.compile.outputs.compiled_count != '0' }}
        shell: pwsh
        run: |
          Compress-Archive -Path "$env:ARTIFACT_DIR\*.exe" -DestinationPath qb64pe_Windows_x64_executables.zip -Force

      - name: Upload artifact (executables)
        if: ${{ steps.compile.outputs.compiled_count != '0' }}
        uses: actions/upload-artifact@v4
        with:
          name: qb64pe-windows-x64-executables
          path: qb64pe_Windows_x64_executables.zip
          retention-days: 30

      - name: Upload compile logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: qb64pe-compile-logs
          path: ${{ env.QB64PE_DIR }}\internal\temp\**

      - name: Job summary
        if: success()
        shell: pwsh
        env:
          EXEC_LIST: ${{ steps.compile.outputs.executables }}
          COUNT:     ${{ steps.compile.outputs.compiled_count }}
        run: |
          @"
          ## QB64-PE Windows x64 Build Complete

          Compiled $env:COUNT program(s):

          $($env:EXEC_LIST -split ' ' | ForEach-Object { "- $_" } | Out-String)

          Download **qb64pe_Windows_x64_executables.zip** from **Artifacts**  
          *Native 64-bit Windows .exe files (no dependencies)*
          "@ | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8