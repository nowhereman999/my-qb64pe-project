name: Compile BasTo6809 on Windows (CD Fix)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # The previous PATH modification step is removed, as we will now 
    # run the executable from its own directory.

    - name: Compile the QB64-PE program
      id: compile_qb64
      shell: powershell
      run: |
        # Define the directory where qb64pe.exe resides
        $toolsDir = ".\tools\qb64pe_Windows_x64"
        $sourceFile = "..\BASIC-To-6809_Source_Code\BasTo6809.bas"
        $exeName = "qb64pe.exe"

        # 1. Change the current directory to the tools directory
        Set-Location -Path $toolsDir

        # 2. Execute the compiler from within its correct environment
        Write-Host "Compiling from CWD: $(Get-Location)"
        & ".\$exeName" -x $sourceFile

    - name: Locate and upload compiled artifact
      # This step only runs if the compilation (previous step) was successful
      if: success()
      shell: powershell
      run: |
        $outputName = "BasTo6809.exe"
        
        # When compiled inside the tools directory, the EXE is likely created there.
        # We need to find its absolute path to upload as an artifact.
        $toolsDir = ".\tools\qb64pe_Windows_x64"
        $compiledPath = Join-Path (Get-Location) $outputName

        # Check if the file exists in the current directory (which is the tools directory for this step)
        if (Test-Path $compiledPath) {
            # Need to get the absolute path for the upload-artifact action
            $absolutePath = (Get-Item $compiledPath).FullName
            echo "Found compiled executable at $absolutePath"
            echo "::set-output name=artifact_path::$absolutePath"
        } else {
            Write-Host "Could not find the compiled executable $outputName in the tools directory."
            exit 1 
        }
      id: find_artifact

    - name: Upload compiled executable as artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: BasTo6809-Windows-x64
        path: ${{ steps.find_artifact.outputs.artifact_path }}
