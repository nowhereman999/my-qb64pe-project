name: Compile QB64-PE (Windows x64) - Test Single File

on:
  workflow_dispatch:
    inputs:
      dummy:
        description: 'Manual trigger for testing'
        required: false

jobs:
  build:
    runs-on: windows-2022
    env:
      QB64PE: ${{ github.workspace }}\tools\qb64pe_Windows_x64\qb64pe.exe
      ARTIFACTS: ${{ github.workspace }}\artifacts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify QB64-PE
        shell: cmd
        run: |
          if not exist "%QB64PE%" (
            echo qb64pe.exe missing!
            exit 1
          )
          echo QB64-PE found.

      - name: Create artifacts folder
        shell: cmd
        run: mkdir "%ARTIFACTS%" >nul

      - name: Compile ONLY BasTo6809.bas
        id: compile
        shell: cmd
        run: |
          set "SOURCE_DIR=%GITHUB_WORKSPACE%\BASIC-To-6809_Source_Code"
          set "TARGET=%SOURCE_DIR%\BasTo6809.bas"

          if not exist "%TARGET%" (
            echo ERROR: BasTo6809.bas not found!
            exit 1
          )

          echo Changing to source directory: %SOURCE_DIR%
          cd /d "%SOURCE_DIR%"

          echo Compiling BasTo6809.bas to BasTo6809.exe
          call "%QB64PE%" -x "BasTo6809.bas" -o "BasTo6809.exe"

          if errorlevel 1 (
            echo.
            echo === COMPILATION FAILED ===
            exit 1
          )

          echo Compilation successful!
          copy "BasTo6809.exe" "%ARTIFACTS%\BasTo6809.exe" /y >nul
          del "BasTo6809.exe" 2>nul

          echo executables=BasTo6809.exe>> "%GITHUB_OUTPUT%"
          echo compiled_count=1>> "%GITHUB_OUTPUT%"

      - name: Print compilelog.txt (always)
        if: always()
        shell: cmd
        run: |
          set "LOG=%GITHUB_WORKSPACE%\BASIC-To-6809_Source_Code\internal\temp\compilelog.txt"
          echo.
          echo ================================
          echo    CONTENTS OF compilelog.txt
          echo ================================
          if exist "%LOG%" (
            echo Found compilelog.txt - printing contents:
            type "%LOG%"
          ) else (
            echo [ERROR] compilelog.txt NOT FOUND at:
            echo     %LOG%
            echo.
            echo Listing internal\temp directory:
            dir "%GITHUB_WORKSPACE%\BASIC-To-6809_Source_Code\internal\temp\" /on 2>nul || echo Directory does not exist
          )
          echo.
          echo ================================

      - name: Create zip
        if: steps.compile.outputs.compiled_count == '1'
        shell: cmd
        run: powershell -Command "Compress-Archive -Path '%ARTIFACTS%\*.exe' -DestinationPath qb64pe_Windows_x64_executables.zip -Force"

      - name: Upload artifact
        if: steps.compile.outputs.compiled_count == '1'
        uses: actions/upload-artifact@v4
        with:
          name: qb64pe-windows-x64-executables
          path: qb64pe_Windows_x64_executables.zip
          retention-days: 30

      - name: Summary
        if: success() && steps.compile.outputs.compiled_count == '1'
        shell: cmd
        run: |
          echo ## QB64-PE Build Complete>> "%GITHUB_STEP_SUMMARY%"
          echo.>> "%GITHUB_STEP_SUMMARY%"
          echo Compiled **1** program: `BasTo6809.exe`>> "%GITHUB_STEP_SUMMARY%"
          echo.>> "%GITHUB_STEP_SUMMARY%"
          echo Download **qb64pe_Windows_x64_executables.zip**>> "%GITHUB_STEP_SUMMARY%"