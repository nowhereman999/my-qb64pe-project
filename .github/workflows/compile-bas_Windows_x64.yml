name: Compile QB64-PE (Windows x64)

on:
  push:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  pull_request:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  workflow_dispatch:
    inputs:
      bas_paths:
        description: 'Comma-separated .bas file paths (relative to repo root)'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest
    env:
      QB64PE_EXE: ${{ github.workspace }}\tools\qb64pe_Windows_x64\qb64pe.exe
      ARTIFACTS_DIR: ${{ github.workspace }}\artifacts

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify QB64-PE Windows x64 setup
        shell: pwsh
        run: |
          $qb64peDir = "$env:GITHUB_WORKSPACE\tools\qb64pe_Windows_x64"
          Write-Host "Looking for QB64-PE in: $qb64peDir"
          if (-not (Test-Path $qb64peDir)) {
            Write-Error "ERROR: $qb64peDir missing! Commit the folder."
            exit 1
          }
          if (-not (Test-Path $env:QB64PE_EXE)) {
            Write-Error "qb64pe.exe missing!"
            exit 1
          }
          if (-not (Test-Path "$qb64peDir\internal")) {
            Write-Error "internal/ folder missing!"
            exit 1
          }
          if (-not (Test-Path "$qb64peDir\Makefile")) {
            Write-Error "Makefile missing!"
            exit 1
          }
          Write-Host "QB64-PE setup verified."

      - name: Create artifacts directory
        shell: pwsh
        run: New-Item -ItemType Directory -Force -Path "$env:ARTIFACTS_DIR" | Out-Null

      - name: Compile selected .bas files
        id: compile
        shell: pwsh
        run: |
          $qb64peDir = "$env:GITHUB_WORKSPACE\tools\qb64pe_Windows_x64"
          $rootDir = "$env:GITHUB_WORKSPACE\BASIC-To-6809_Source_Code"
          $filesToCompile = @()

          if ($env:INPUT_BAS_PATHS) {
            $filesToCompile = $env:INPUT_BAS_PATHS -split ',' | ForEach-Object { $_.Trim() }
          } else {
            $rootFiles = Get-ChildItem -Path $rootDir -File | Where-Object {
              $_.Extension -match '^\.[bB][aA][sS]$'
            } | ForEach-Object { $_.FullName.Substring($env:GITHUB_WORKSPACE.Length + 1) }

            $sdecbPath = $null
            @("IDE\SDECB.bas", "IDE\SDECB.BAS") | ForEach-Object {
              $p = Join-Path $rootDir $_
              if (Test-Path $p) { $sdecbPath = $p.Substring($env:GITHUB_WORKSPACE.Length + 1) }
            }

            $filesToCompile = $rootFiles
            if ($sdecbPath) { $filesToCompile += $sdecbPath }
          }

          $filesToCompile = $filesToCompile | Sort-Object -Unique
          if ($filesToCompile.Count -eq 0) {
            Write-Host "No .bas files to compile."
            "executables=" >> $env:GITHUB_OUTPUT
            "compiled_count=0" >> $env:GITHUB_OUTPUT
            exit 0
          }

          Write-Host "Compiling $($filesToCompile.Count) file(s):"
          $filesToCompile | ForEach-Object { Write-Host " - $_" }

          $executables = @()
          $count = 0

          foreach ($relPath in $filesToCompile) {
            $fullPath = Join-Path $env:GITHUB_WORKSPACE $relPath
            if (-not (Test-Path $fullPath)) { continue }

            $dir = Split-Path $fullPath -Parent
            $filename = Split-Path $fullPath -Leaf
            $base = [System.IO.Path]::GetFileNameWithoutExtension($filename)

            Push-Location $dir
            Write-Host "`nCompiling (in $(Split-Path $relPath -Parent)): $filename -> $base.exe"

            $process = Start-Process `
              -FilePath $env:QB64PE_EXE `
              -ArgumentList "-x", $filename, "-o", "$base.exe" `
              -Wait `
              -PassThru `
              -NoNewWindow `
              -RedirectStandardOutput "$env:TEMP\qb64pe_stdout.txt" `
              -RedirectStandardError "$env:TEMP\qb64pe_stderr.txt"

            if (Test-Path "$env:TEMP\qb64pe_stdout.txt") {
              Get-Content "$env:TEMP\qb64pe_stdout.txt" | Write-Host
            }
            if (Test-Path "$env:TEMP\qb64pe_stderr.txt") {
              Get-Content "$env:TEMP\qb64pe_stderr.txt" | Write-Host
            }

            if ($process.ExitCode -ne 0) {
              $logPath = "$qb64peDir\internal\temp\compilelog.txt"
              Write-Host "`n=== COMPILATION ERROR ==="
              if (Test-Path $logPath) { Get-Content $logPath | Write-Host }
              else { Write-Host "compilelog.txt not found." }
              Write-Host "=========================`n"
              Pop-Location
              exit 1
            }

            if (-not (Test-Path "$base.exe")) {
              Write-Error "ERROR: $base.exe was not created!"
              Pop-Location
              exit 1
            }

            Write-Host "-> $base.exe created and copied to artifacts"
            Copy-Item "$base.exe" "$env:ARTIFACTS_DIR\$base.exe" -Force
            Remove-Item "$base.exe" -Force -ErrorAction SilentlyContinue
            $executables += "$base.exe"
            $count++
            Pop-Location
          }

          $execList = $executables -join ' '
          "executables=$execList" >> $env:GITHUB_OUTPUT
          "compiled_count=$count" >> $env:GITHUB_OUTPUT

      - name: Create zip archive
        if: steps.compile.outputs.compiled_count > 0
        shell: pwsh
        run: |
          Set-Location "$env:ARTIFACTS_DIR"
          $exes = "${{ steps.compile.outputs.executables }}" -split ' ' | Where-Object { $_ -ne '' }
          Compress-Archive -Path $exes -DestinationPath qb64pe_Windows_x64_executables.zip -Force
          Write-Host "Zipped $($exes.Count) executable(s)"

      - name: Upload artifact
        if: steps.compile.outputs.compiled_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: qb64pe-windows-x64-executables
          path: ${{ github.workspace }}\artifacts\qb64pe_Windows_x64_executables.zip
          retention-days: 30

      - name: Job summary
        if: success()
        shell: pwsh
        run: |
          $summary = "## QB64-PE Windows x64 Build Complete`n"
          $summary += "Compiled **${{ steps.compile.outputs.compiled_count }}** program(s):`n`n"

          # FIXED: Use PowerShell loop with real variable
          $exeList = "${{ steps.compile.outputs.executables }}".Trim()
          if ($exeList) {
            $exeList -split ' ' | Where-Object { $_ -ne '' } | ForEach-Object {
              $summary += "- `$_`n"
            }
          } else {
            $summary += "*No executables generated.*`n"
          }

          $summary += "`nDownload the zip from **Artifacts** below`n"
          $summary += "*These are native Windows x64 executables.*`n"

          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append