name: Compile QB64-PE (Windows x64)
on:
  push:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  pull_request:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  workflow_dispatch:
    inputs:
      bas_paths:
        description: 'Comma-separated .bas file paths (relative to repo root)'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify QB64-PE Windows setup
        run: |
          $QB64PE_DIR = "$env:GITHUB_WORKSPACE\tools\qb64pe_Windows_x64"
          if (-not (Test-Path "$QB64PE_DIR\qb64pe.exe")) {
            Write-Error "qb64pe.exe missing! Commit tools/qb64pe_Windows_x64/"
            exit 1
          }
          if (-not (Test-Path "$QB64PE_DIR\internal")) {
            Write-Error "internal/ folder missing!"
            exit 1
          }
          Write-Output "QB64-PE Windows setup verified."

      - name: Compile selected .bas files
        id: compile
        shell: pwsh
        run: |
          $QB64PE_DIR = "$env:GITHUB_WORKSPACE\tools\qb64pe_Windows_x64"
          $ARTIFACT_DIR = "$env:GITHUB_WORKSPACE\artifacts"
          New-Item -ItemType Directory -Force -Path $ARTIFACT_DIR

          if ($env:INPUT_BAS_PATHS) {
            $FILES = $env:INPUT_BAS_PATHS -split ','
          } else {
            $ROOT_DIR = "$env:GITHUB_WORKSPACE\BASIC-To-6809_Source_Code"
            $ROOT_FILES = Get-ChildItem "$ROOT_DIR\*" -Include *.bas, *.BAS | ForEach-Object { $_.FullName.Substring($env:GITHUB_WORKSPACE.Length + 1) }

            $SDECB_PATH = ""
            if (Test-Path "$ROOT_DIR\IDE\SDECB.bas") { $SDECB_PATH = "BASIC-To-6809_Source_Code/IDE/SDECB.bas" }
            elseif (Test-Path "$ROOT_DIR\IDE\SDECB.BAS") { $SDECB_PATH = "BASIC-To-6809_Source_Code/IDE/SDECB.BAS" }

            $FILES = $ROOT_FILES
            if ($SDECB_PATH) { $FILES += $SDECB_PATH }
          }

          # Remove duplicates
          $UNIQUE = $FILES | Sort-Object -Unique
          if ($UNIQUE.Count -eq 0) {
            echo "executables=" >> $env:GITHUB_OUTPUT
            echo "compiled_count=0" >> $env:GITHUB_OUTPUT
            exit 0
          }

          Write-Output "Compiling $($UNIQUE.Count) file(s):"
          $UNIQUE | ForEach-Object { Write-Output " - $_" }

          $EXECUTABLES = @()
          $COUNT = 0

          foreach ($file in $UNIQUE) {
            $file = $file.Trim()
            if (-not ($file -match '\.[bB][aA][sS]$')) { continue }

            $rel_dir = Split-Path $file -Parent
            $filename = Split-Path $file -Leaf
            $base = [System.IO.Path]::GetFileNameWithoutExtension($filename)
            $full_dir = "$env:GITHUB_WORKSPACE\$rel_dir"

            Set-Location $full_dir
            Write-Output "Compiling: $filename â†’ $base.exe"

            & "$QB64PE_DIR\qb64pe.exe" -x "$filename" -o "$base.exe"
            if ($LASTEXITCODE -ne 0) {
              $LOG = "$QB64PE_DIR\internal\temp\compilelog.txt"
              Write-Output "=== COMPILATION ERROR ==="
              if (Test-Path $LOG) { Get-Content $LOG }
              else { Write-Output "compilelog.txt not found." }
              Write-Output "========================"
              exit 1
            }

            Copy-Item "$base.exe" "$ARTIFACT_DIR\$base.exe"
            Remove-Item "$base.exe" -ErrorAction SilentlyContinue
            $EXECUTABLES += "$base.exe"
            $COUNT++
          }

          $EXEC_LIST = $EXECUTABLES -join " "
          echo "executables=$EXEC_LIST" >> $env:GITHUB_OUTPUT
          echo "compiled_count=$COUNT" >> $env:GITHUB_OUTPUT

      - name: Create zip archive
        if: steps.compile.outputs.compiled_count > 0
        run: |
          Compress-Archive -Path "$env:GITHUB_WORKSPACE\artifacts\*.exe" -DestinationPath qb64pe_Windows_x64_executables.zip

      - name: Upload artifact
        if: steps.compile.outputs.compiled_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: qb64pe-windows-x64-executables
          path: qb64pe_Windows_x64_executables.zip
          retention-days: 30

      - name: Job summary
        if: success()
        run: |
          echo "## QB64-PE Windows x64 Build Complete" >> $env:GITHUB_STEP_SUMMARY
          echo "Compiled ${{ steps.compile.outputs.compiled_count }} program(s):" >> $env:GITHUB_STEP_SUMMARY
          echo "" >> $env:GITHUB_STEP_SUMMARY
          ${{ steps.compile.outputs.executables }}.Split() | ForEach-Object { echo "- `$_`" >> $env:GITHUB_STEP_SUMMARY }
          echo "" >> $env:GITHUB_STEP_SUMMARY
          echo "Download **qb64pe_Windows_x64_executables.zip** from **Artifacts**" >> $env:GITHUB_STEP_SUMMARY
          echo "*Native 64-bit Windows .exe files (no dependencies)*" >> $env:GITHUB_STEP_SUMMARY