name: Compile QB64-PE (Windows x64)

on:
  push:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  pull_request:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  workflow_dispatch:
    inputs:
      bas_paths:
        description: 'Comma-separated .bas file paths (relative to repo root)'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install MinGW (Chocolatey)
        shell: pwsh
        run: |
          choco install mingw --version=12.2.0.03042022 -y --no-progress

      - name: Add MinGW to PATH
        shell: pwsh
        run: |
          $candidates = @(
            'C:\tools\mingw64\bin',
            'C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin',
            'C:\mingw64\bin'
          )
          foreach ($p in $candidates) {
            if (Test-Path $p) {
              $env:PATH = "$p;" + $env:PATH
              "$p" | Out-File -FilePath $env:GITHUB_PATH -Append
            }
          }
          gcc --version
          g++ --version

      - name: Verify QB64-PE setup
        shell: pwsh
        run: |
          $QB64PE_DIR = "$env:GITHUB_WORKSPACE\tools\qb64pe_Windows_x64"
          if (-not (Test-Path "$QB64PE_DIR\qb64pe.exe")) {
            Write-Error "qb64pe.exe missing! Commit tools/qb64pe_Windows_x64/"
            exit 1
          }
          Write-Output "QB64-PE found."

      - name: Override internal compiler with system MinGW
        shell: pwsh
        run: |
          $QB64PE_DIR = "$env:GITHUB_WORKSPACE\tools\qb64pe_Windows_x64"
          $internal = "$QB64PE_DIR\internal\c\c_compiler"
          Remove-Item -Recurse -Force $internal -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force -Path "$internal\bin" | Out-Null

          $gccPath  = (Get-Command gcc.exe).Path
          $gppPath  = (Get-Command g++.exe).Path
          $makePath = (Get-Command make.exe).Path

          if (-not $gccPath) {
            Write-Error "gcc not found in PATH"
            exit 1
          }

          @"
@echo off
"$gccPath" %*
"@ | Out-File -Encoding ASCII -FilePath "$internal\bin\gcc.exe"

          @"
@echo off
"$gppPath" %*
"@ | Out-File -Encoding ASCII -FilePath "$internal\bin\g++.exe"

          @"
@echo off
"$makePath" %*
"@ | Out-File -Encoding ASCII -FilePath "$internal\bin\make.exe"

          $dlls = @("libgcc_s_seh-1.dll", "libstdc++-6.dll", "libwinpthread-1.dll")
          $binDir = Split-Path $gccPath
          foreach ($dll in $dlls) {
            $src = Join-Path $binDir $dll
            if (Test-Path $src) {
              Copy-Item $src "$internal\bin\" -Force
            }
          }

          Write-Output "Internal compiler overridden with system MinGW"

      - name: Compile selected .bas files
        id: compile
        shell: pwsh
        run: |
          $QB64PE_DIR = "$env:GITHUB_WORKSPACE\tools\qb64pe_Windows_x64"
          $ARTIFACT_DIR = "$env:GITHUB_WORKSPACE\artifacts"
          New-Item -ItemType Directory -Force -Path $ARTIFACT_DIR | Out-Null

          if ($env:INPUT_BAS_PATHS) {
            $FILES = $env:INPUT_BAS_PATHS -split ','
          } else {
            $ROOT_DIR = "$env:GITHUB_WORKSPACE\BASIC-To-6809_Source_Code"
            $ROOT_FILES = Get-ChildItem "$ROOT_DIR\*" -Include *.bas, *.BAS -File |
              ForEach-Object { $_.FullName.Substring($env:GITHUB_WORKSPACE.Length + 1) }

            $SDECB_PATH = ""
            @("SDECB.bas", "SDECB.BAS") | ForEach-Object {
              $p = "$ROOT_DIR\IDE\$_"
              if (Test-Path $p) { $SDECB_PATH = "BASIC-To-6809_Source_Code/IDE/$_" }
            }

            $FILES = $ROOT_FILES
            if ($SDECB_PATH) { $FILES += $SDECB_PATH }
          }

          $UNIQUE = $FILES | Sort-Object -Unique | Where-Object { $_ -match '\.[bB][aA][sS]$' }
          if ($UNIQUE.Count -eq 0) {
            echo "executables=" >> $env:GITHUB_OUTPUT
            echo "compiled_count=0" >> $env:GITHUB_OUTPUT
            exit 0
          }

          Write-Output "Compiling $($UNIQUE.Count) file(s):"
          $UNIQUE | ForEach-Object { Write-Output " - $_" }

          $EXECUTABLES = @()
          $COUNT = 0

          foreach ($file in $UNIQUE) {
            $file = $file.Trim()
            $rel_dir = Split-Path $file -Parent
            $filename = Split-Path $file -Leaf
            $base = [System.IO.Path]::GetFileNameWithoutExtension($filename)
            $full_dir = "$env:GITHUB_WORKSPACE\$rel_dir"
            Set-Location $full_dir

            Write-Output "Compiling: $filename â†’ $base.exe"
            & "$QB64PE_DIR\qb64pe.exe" -x "$filename" -o "$base.exe"

            if ($LASTEXITCODE -ne 0) {
              $LOG = "$QB64PE_DIR\internal\temp\compilelog.txt"
              Write-Output "=== COMPILATION ERROR ==="
              if (Test-Path $LOG) { Get-Content $LOG }
              else { Write-Output "No compilelog.txt" }
              Write-Output "========================"
              exit 1
            }

            Copy-Item "$base.exe" "$ARTIFACT_DIR\$base.exe" -Force
            Remove-Item "$base.exe" -ErrorAction SilentlyContinue
            $EXECUTABLES += "$base.exe"
            $COUNT++
          }

          $EXEC_LIST = $EXECUTABLES -join " "
          echo "executables=$EXEC_LIST" >> $env:GITHUB_OUTPUT
          echo "compiled_count=$COUNT" >> $env:GITHUB_OUTPUT

      - name: Create zip archive
        if: steps.compile.outputs.compiled_count > 0
        shell: pwsh
        run: |
          Compress-Archive -Path "$env:GITHUB_WORKSPACE\artifacts\*.exe" -DestinationPath qb64pe_Windows_x64_executables.zip -Force

      - name: Upload artifact
        if: steps.compile.outputs.compiled_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: qb64pe-windows-x64-executables
          path: qb64pe_Windows_x64_executables.zip
          retention-days: 30

      - name: Job summary
        if: success() && steps.compile.outputs.compiled_count > 0
        shell: pwsh
        run: |
          Add-Content $env:GITHUB_STEP_SUMMARY '## QB64-PE Windows x64 Build Complete'
          Add-Content $env:GITHUB_STEP_SUMMARY ''
          Add-Content $env:GITHUB_STEP_SUMMARY "Compiled **${{ steps.compile.outputs.compiled_count }}** program(s):"
          Add-Content $env:GITHUB_STEP_SUMMARY ''
          "${{ steps.compile.outputs.executables }}" -split ' ' | ForEach-Object {
            Add-Content $env:GITHUB_STEP_SUMMARY "- `$_`"
          }
          Add-Content $env:GITHUB_STEP_SUMMARY ''
          Add-Content $env:GITHUB_STEP_SUMMARY 'Download **qb64pe_Windows_x64_executables.zip** from Artifacts'
          Add-Content $env:GITHUB_STEP_SUMMARY '*Native 64-bit Windows .exe files (no dependencies)*'