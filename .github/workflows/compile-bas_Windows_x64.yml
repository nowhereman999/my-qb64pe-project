name: Compile BasTo6809 on Windows (Refined)

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest
    env:
      TOOLS_DIR_REL: tools\qb64pe_Windows_x64
      SOURCE_FILE_REL: BASIC-To-6809_Source_Code\BasTo6809.bas
      OUTPUT_EXE_NAME: BasTo6809.exe

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Compile the QB64-PE program and capture status
      id: compile_qb64_attempt
      shell: powershell
      continue-on-error: true
      run: |
        # Set absolute paths for clarity
        $toolsDir = Join-Path $env:GITHUB_WORKSPACE $env:TOOLS_DIR_REL
        $sourceFile = Join-Path $env:GITHUB_WORKSPACE $env:SOURCE_FILE_REL
        $exePath = Join-Path $toolsDir qb64pe.exe

        # Change directory to the tools folder where qb64pe.exe resides
        Set-Location -Path $toolsDir
        Write-Host "Compiling from CWD: $(Get-Location)"

        # Execute the compiler
        & $exePath -x $sourceFile
        # The script exits here with the compiler's error code (0 for success, 1 for failure)
      
      # We do NOT change directory back here, as this script exits when finished

    - name: Locate and Display compilelog.txt
      # This step runs regardless of whether the compile step succeeded or failed.
      run: |
        Write-Host "Searching for compilelog.txt..."
        # Search relative to the tools directory, as that was the last CWD
        $logFile = Get-ChildItem -Path $env:TOOLS_DIR_REL -Recurse -Filter "compilelog.txt" -ErrorAction SilentlyContinue | Select-Object -First 1

        if ($logFile) {
            Write-Host "--- Found compilelog.txt at $($logFile.FullName) ---"
            Write-Host "--- Start of compilelog.txt content ---"
            Get-Content $logFile.FullName
            Write-Host "--- End of compilelog.txt content ---"
        } else {
            Write-Host "ERROR: Could not find compilelog.txt."
            exit 1 
        }
      shell: powershell

    - name: Check compilation status and fail job if needed
      # Check the outcome of the first step
      if: steps.compile_qb64_attempt.outcome == 'failure'
      run: |
        echo "Compilation failed. The compilelog.txt shows POSIX paths being used which indicates a non-Windows compiler configuration."
        exit 1 # Force the GitHub job to fail permanently

    - name: Locate compiled artifact
      if: success()
      id: find_artifact
      shell: powershell
      run: |
        # Search for the output EXE within the tools directory
        $compiledPath = Join-Path $env:TOOLS_DIR_REL $env:OUTPUT_EXE_NAME
        
        if (Test-Path $compiledPath) {
            $absolutePath = (Get-Item $compiledPath).FullName
            echo "::set-output name=artifact_path::$absolutePath"
        } else {
            Write-Host "Could not find the compiled executable $($env:OUTPUT_EXE_NAME)."
            exit 1 
        }

    - name: Upload compiled executable as artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: BasTo6809-Windows-x64
        path: ${{ steps.find_artifact.outputs.artifact_path }}
