name: Build (QB64-PE matrix)

on:
  push:
    branches: [ main ]
  pull_request:

env:
  APP_NAME: MyProgram             # change to your program name (no extension)
  ENTRY_BAS: src/main.bas         # change to your entry .BAS file path
  QB64PE_REPO: https://github.com/QB64-Phoenix-Edition/QB64pe.git

jobs:
  # -------- macOS Intel (x86_64) --------
  macos-intel:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - name: Clone QB64-PE
        run: git clone --depth=1 "$QB64PE_REPO" qb64pe
      - name: Build QB64-PE tool
        run: |
          cd qb64pe
          ./setup_osx.command
      - name: Compile BAS (macOS Intel)
        run: |
          ./qb64pe/qb64pe -x "$ENTRY_BAS" -o "build/${{ env.APP_NAME }}-macOS-Intel"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macOS-Intel
          path: build/${{ env.APP_NAME }}-macOS-Intel

  # -------- macOS Apple Silicon (arm64) --------
  macos-arm:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Clone QB64-PE
        run: git clone --depth=1 "$QB64PE_REPO" qb64pe
      - name: Build QB64-PE tool
        run: |
          cd qb64pe
          ./setup_osx.command
      - name: Compile BAS (macOS ARM)
        run: |
          ./qb64pe/qb64pe -x "$ENTRY_BAS" -o "build/${{ env.APP_NAME }}-macOS-ARM"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macOS-ARM
          path: build/${{ env.APP_NAME }}-macOS-ARM

  # -------- Ubuntu Linux x86_64 --------
  linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps (OpenGL/ALSA/etc.)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git \
            libgl1-mesa-dev libglu1-mesa-dev freeglut3-dev \
            libx11-dev libxext-dev libxi-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libasound2-dev libpulse-dev libudev-dev
      - name: Clone QB64-PE
        run: git clone --depth=1 "$QB64PE_REPO" qb64pe
      - name: Build QB64-PE tool
        run: |
          cd qb64pe
          ./setup_lnx.sh
      - name: Compile BAS (Linux x64)
        run: |
          ./qb64pe/qb64pe -x "$ENTRY_BAS" -o "build/${{ env.APP_NAME }}-linux-x64"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-x64
          path: build/${{ env.APP_NAME }}-linux-x64

  # -------- Windows x64 --------
  windows-x64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download prebuilt QB64-PE (Windows)
        shell: pwsh
        run: |
          # grab latest release archive (Windows). Adjust pattern if needed.
          $release = Invoke-RestMethod https://api.github.com/repos/QB64-Phoenix-Edition/QB64pe/releases/latest
          $asset = $release.assets | Where-Object { $_.name -match "windows" -and $_.name -match "\.7z$" } | Select-Object -First 1
          Invoke-WebRequest $asset.browser_download_url -OutFile qb64pe.7z
          7z x qb64pe.7z -oqb64pe
      - name: Compile BAS (Windows)
        shell: pwsh
        run: |
          .\qb64pe\qb64pe.exe -x "$env:ENTRY_BAS" -o "build\${env:APP_NAME}-windows.exe"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows
          path: build/${{ env.APP_NAME }}-windows.exe

  # -------- Raspberry Pi (self-hosted) --------
  # Set up a self-hosted runner on your Pi (labels: self-hosted, Linux, ARM64 or ARM)
  raspberry-pi:
    if: ${{ always() }}  # let it try if you have a Pi runner; otherwise it will be skipped
    runs-on: [self-hosted, Linux, ARM64]
    steps:
      - uses: actions/checkout@v4
      - name: Install deps (may need sudo)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git \
            libgl1-mesa-dev libglu1-mesa-dev freeglut3-dev \
            libx11-dev libxext-dev libxi-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libasound2-dev libpulse-dev libudev-dev
      - name: Clone QB64-PE
        run: git clone --depth=1 "$QB64PE_REPO" qb64pe
      - name: Build QB64-PE tool (Pi)
        run: |
          cd qb64pe
          ./setup_lnx.sh
      - name: Compile BAS (Pi native)
        run: |
          ./qb64pe/qb64pe -x "$ENTRY_BAS" -o "build/${{ env.APP_NAME }}-raspi"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-raspi
          path: build/${{ env.APP_NAME }}-raspi
