name: Build QB64PE Binaries

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]  # Optional: Trigger on tags for releases

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: lnx
            ext: tar.gz
            setup: setup_lnx.sh
            arch_label: x64
          - os: windows-latest
            platform: win-x64
            ext: zip
            setup: ''
            arch_label: x64
          - os: macos-12
            platform: osx
            ext: tar.gz
            setup: setup_osx.command
            arch_label: x86_64
          - os: macos-13
            platform: osx
            ext: tar.gz
            setup: setup_osx.command
            arch_label: arm64
          - os: ubuntu-24.04-arm  # New: For Raspberry Pi (ARM64 Linux)
            platform: lnx-aarch64
            ext: tar.gz
            setup: setup_lnx.sh
            arch_label: arm64-rpi
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest QB64PE release
        id: get_release
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.repos.getLatestRelease({
              owner: 'QB64-Phoenix-Edition',
              repo: 'QB64pe'
            });
            const tag = response.data.tag_name;
            const version = tag.replace(/^v/, '');
            core.setOutput('tag', tag);
            core.setOutput('version', version);

      - name: Set up QB64PE
        env:
          DOWNLOAD_URL: https://github.com/QB64-Phoenix-Edition/QB64pe/releases/download/${{ steps.get_release.outputs.tag }}/qb64pe_${{ matrix.platform }}-${{ steps.get_release.outputs.version }}.${{ matrix.ext }}
        run: |
          if [ '${{ runner.os }}' == 'Linux' ] || [ '${{ runner.os }}' == 'macOS' ]; then
            curl -L "$DOWNLOAD_URL" -o qb64pe.${{ matrix.ext }}
            tar xzf qb64pe.tar.gz
            mv qb64pe* qb64pe  # Adjust if extract folder differs
            cd qb64pe
            chmod +x ${{ matrix.setup }}
            ./${{ matrix.setup }}
            cd ..
          else  # Windows
            curl.exe -L -o qb64pe.zip "$env:DOWNLOAD_URL"
            powershell Expand-Archive qb64pe.zip -DestinationPath .
            mv qb64pe_win-x64* qb64pe  # Adjust if extract folder differs
          fi

      - name: Compile program
        run: |
          cd qb64pe
          if [ '${{ runner.os }}' == 'Windows' ]; then
            .\qb64.exe -c ..\myprogram.bas
          else
            ./qb64 -c ../myprogram.bas
          fi
          cd ..

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: myprogram-${{ matrix.os }}-${{ matrix.arch_label }}
          path: qb64pe/myprogram*
          retention-days: 30  # Keep artifacts for 30 days

      - name: Create Release (optional, on tags)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: qb64pe/myprogram*
          generate_release_notes: true
