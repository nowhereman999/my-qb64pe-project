name: Build (QB64-PE prebuilt, CLI-only)

on:
  push:
    branches: [ main ]
  pull_request:

env:
  APP_NAME: MyProgram
  ENTRY_BAS: src/main.bas
  API_URL: https://api.github.com/repos/QB64-Phoenix-Edition/QB64pe/releases/latest

jobs:
  # -------------------- Windows x64 --------------------
  windows-x64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure 7-Zip
        shell: pwsh
        run: |
          choco install -y 7zip
          $env:Path += ";C:\Program Files\7-Zip"
          7z i | Out-Null

      - name: Download prebuilt QB64-PE (Windows)
        shell: pwsh
        run: |
          $release = Invoke-RestMethod $env:API_URL
          $asset = $release.assets | Where-Object {
            $_.name -match 'qb64pe_(win|windows)-(x64|arm64).*\.(7z|zip)$'
          } | Select-Object -First 1
          if (-not $asset) { throw "No Windows asset found in latest QB64-PE release." }

          $out = if ($asset.name -match '\.7z$') { 'qb64pe.7z' } else { 'qb64pe.zip' }
          Invoke-WebRequest $asset.browser_download_url -OutFile $out

          New-Item -ItemType Directory -Force -Path qb64pe | Out-Null
          if (Test-Path qb64pe.7z) { 7z x qb64pe.7z -oqb64pe | Out-Null } else { Expand-Archive qb64pe.zip -DestinationPath qb64pe -Force }

          $exe = Get-ChildItem -Path qb64pe -Recurse -Filter qb64pe.exe -File | Select-Object -First 1
          if (-not $exe) { throw "qb64pe.exe not found after extraction." }
          "$($exe.FullName)" | Out-File -FilePath qb64pe_path.txt -Encoding ascii

      - name: Detect ENTRY_BAS (Windows)
        shell: pwsh
        run: |
          $candidates = @("$env:ENTRY_BAS", "./Hello.BAS", "Hello.BAS")
          $found = $null
          foreach ($p in $candidates) { if ($p -and (Test-Path $p)) { $found = $p; break } }
          if (-not $found) {
            $first = Get-ChildItem -Recurse -Include *.bas -File | Select-Object -First 1
            if ($first) { $found = $first.FullName }
          }
          if (-not $found) { throw "No .BAS file found. Set env ENTRY_BAS or add a file." }
          "ENTRY_BAS=$found" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Compile BAS (Windows, CLI only)
        shell: pwsh
        run: |
          $qb = Get-Content qb64pe_path.txt -Raw
          if (-not (Test-Path $env:ENTRY_BAS)) { throw "ENTRY_BAS not found: $env:ENTRY_BAS" }
          New-Item -ItemType Directory -Force -Path build | Out-Null
          & $qb -x "$env:ENTRY_BAS" -o "build\${env:APP_NAME}-windows.exe"

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-windows
          path: build/${{ env.APP_NAME }}-windows.exe

  # -------------------- macOS Intel (x64) --------------------
  macos-intel:
    runs-on: macos-13   # Intel host
    steps:
      - uses: actions/checkout@v4

      - name: Download prebuilt QB64-PE (macOS x64)
        run: |
          set -euo pipefail
          release="$(curl -fsSL "$API_URL")"
          url="$(printf '%s\n' "$release" \
            | grep -Eo '"browser_download_url": *"[^"]+"' \
            | sed -E 's/.*"([^"]+)"/\1/' \
            | grep -E '(qb64pe_(osx|mac)-(x64|amd64|x86_64).*\.(tar\.gz|zip))$' \
            | head -n1)"
          [ -n "$url" ] || { echo "No macOS x64 asset found."; exit 1; }
          name="$(basename "$url")"
          curl -fsSL "$url" -o "$name"
          mkdir -p qb64pe
          case "$name" in
            *.zip)    unzip -q "$name" -d qb64pe ;;
            *.tar.gz) tar -xzf "$name" -C qb64pe ;;
          esac
          # Find CLI (inside .app bundle or standalone)
          qb="$(/usr/bin/find qb64pe -type f \( -name 'qb64pe' -o -name 'QB64-PE' \) | head -n1)"
          if [ -z "$qb" ]; then
            qb="$(/usr/bin/find qb64pe -type f -path '*/QB64-PE.app/Contents/MacOS/*' | head -n1)"
          fi
          [ -n "$qb" ] || { echo "qb64pe CLI not found"; exit 1; }
          chmod +x "$qb" || true
          echo "$qb" > qb64pe_path.txt

      - name: Detect ENTRY_BAS (*nix)
        run: |
          set -euo pipefail
          if [ -n "${ENTRY_BAS:-}" ] && [ -f "$ENTRY_BAS" ]; then
            found="$ENTRY_BAS"
          elif [ -f "src/main.bas" ]; then
            found="src/main.bas"
          elif [ -f "main.bas" ]; then
            found="main.bas"
          else
            found="$(find . -type f -name '*.bas' | head -n1 || true)"
          fi
          [ -n "${found:-}" ] || { echo "No .BAS file found. Set env ENTRY_BAS or add a file."; exit 1; }
          echo "ENTRY_BAS=$found" >> "$GITHUB_ENV"

      - name: Compile BAS (macOS Intel, CLI only)
        run: |
          set -euo pipefail
          qb="$(cat qb64pe_path.txt)"
          [ -f "$ENTRY_BAS" ] || { echo "ENTRY_BAS not found: $ENTRY_BAS"; exit 1; }
          mkdir -p build
          "$qb" -x "$ENTRY_BAS" -o "build/${APP_NAME}-macOS-Intel"

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macOS-Intel
          path: build/${{ env.APP_NAME }}-macOS-Intel

  # -------------------- macOS ARM (Apple Silicon) --------------------
  macos-arm:
    runs-on: macos-latest   # Apple Silicon host
    steps:
      - uses: actions/checkout@v4

      - name: Use Uploaded QB64PE (macOS ARM)
        run: |
          set -euo pipefail
          mkdir -p qb64pe
          cp tools/qb64pe_mac_arm/qb64pe qb64pe/qb64pe  # Copy from repo to working dir
          qb="qb64pe/qb64pe"
          chmod +x "$qb"
          [ -x "$qb" ] || { echo "QB64PE not executable"; exit 1; }
          echo "$qb" > qb64pe_path.txt

      - name: Detect ENTRY_BAS (*nix)
        run: |
          set -euo pipefail
          if [ -n "${ENTRY_BAS:-}" ] && [ -f "$ENTRY_BAS" ]; then
            found="$ENTRY_BAS"
          elif [ -f "src/main.bas" ]; then
            found="src/main.bas"
          elif [ -f "main.bas" ]; then
            found="main.bas"
          else
            found="$(find . -type f -name '*.bas' | head -n1 || true)"
          fi
          [ -n "${found:-}" ] || { echo "No .BAS file found. Set env ENTRY_BAS or add a file."; exit 1; }
          echo "ENTRY_BAS=$found" >> "$GITHUB_ENV"

      - name: Compile BAS (macOS ARM, CLI only)
        run: |
          set -euo pipefail
          qb="$(cat qb64pe_path.txt)"
          [ -f "$ENTRY_BAS" ] || { echo "ENTRY_BAS not found: $ENTRY_BAS"; exit 1; }
          mkdir -p build
          "$qb" -x "$ENTRY_BAS" -o "build/${APP_NAME}-macOS-ARM"

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macOS-ARM
          path: build/${{ env.APP_NAME }}-macOS-ARM

  # -------------------- Ubuntu Linux x64 --------------------
  linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download prebuilt QB64-PE (Linux x64)
        run: |
          set -euo pipefail
          release="$(curl -fsSL "$API_URL")"
          url="$(printf '%s\n' "$release" \
            | grep -Eo '"browser_download_url": *"[^"]+"' \
            | sed -E 's/.*"([^"]+)"/\1/' \
            | grep -E '(qb64pe_linux-(x64|amd64).*\.(tar\.gz|zip))$' \
            | head -n1)"
          [ -n "$url" ] || { echo "No Linux x64 asset found."; exit 1; }
          name="$(basename "$url")"
          curl -fsSL "$url" -o "$name"
          mkdir -p qb64pe
          case "$name" in
            *.zip)    unzip -q "$name" -d qb64pe ;;
            *.tar.gz) tar -xzf "$name" -C qb64pe ;;
          esac
          qb="$(find qb64pe -type f -name qb64pe -perm -111 | head -n1)"
          [ -n "$qb" ] || { echo "qb64pe CLI not found"; exit 1; }
          chmod +x "$qb" || true
          echo "$qb" > qb64pe_path.txt

      - name: Detect ENTRY_BAS (*nix)
        run: |
          set -euo pipefail
          if [ -n "${ENTRY_BAS:-}" ] && [ -f "$ENTRY_BAS" ]; then
            found="$ENTRY_BAS"
          elif [ -f "src/main.bas" ]; then
            found="src/main.bas"
          elif [ -f "main.bas" ]; then
            found="main.bas"
          else
            found="$(find . -type f -name '*.bas' | head -n1 || true)"
          fi
          [ -n "${found:-}" ] || { echo "No .BAS file found. Set env ENTRY_BAS or add a file."; exit 1; }
          echo "ENTRY_BAS=$found" >> "$GITHUB_ENV"

      - name: Compile BAS (Linux x64, CLI only)
        run: |
          set -euo pipefail
          qb="$(cat qb64pe_path.txt)"
          [ -f "$ENTRY_BAS" ] || { echo "ENTRY_BAS not found: $ENTRY_BAS"; exit 1; }
          mkdir -p build
          "$qb" -x "$ENTRY_BAS" -o "build/${APP_NAME}-linux-x64"

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-x64
          path: build/${{ env.APP_NAME }}-linux-x64

  # -------------------- Raspberry Pi (self-hosted) --------------------
  raspberry-pi:
    if: ${{ always() }}
    runs-on: [self-hosted, Linux, ARM64]
    steps:
      - uses: actions/checkout@v4
      - name: Download prebuilt QB64-PE (Linux ARM / Pi)
        run: |
          set -euo pipefail
          release="$(curl -fsSL "$API_URL")"
          url="$(printf '%s\n' "$release" \
            | grep -Eo '"browser_download_url": *"[^"]+"' \
            | sed -E 's/.*"([^"]+)"/\1/' \
            | grep -Ei '(qb64pe_linux-(arm64|aarch64|armhf).*\.(tar\.gz|zip))$' \
            | head -n1)"
          [ -n "$url" ] || { echo "No Linux ARM (Pi) asset found."; exit 1; }
          name="$(basename "$url")"
          curl -fsSL "$url" -o "$name"
          mkdir -p qb64pe
          case "$name" in
            *.zip)    unzip -q "$name" -d qb64pe ;;
            *.tar.gz) tar -xzf "$name" -C qb64pe ;;
          esac
          qb="$(find qb64pe -type f -name qb64pe -perm -111 | head -n1)"
          [ -n "$qb" ] || { echo "qb64pe CLI not found"; exit 1; }
          chmod +x "$qb" || true
          echo "$qb" > qb64pe_path.txt

      - name: Detect ENTRY_BAS (*nix)
        run: |
          set -euo pipefail
          if [ -n "${ENTRY_BAS:-}" ] && [ -f "$ENTRY_BAS" ]; then
            found="$ENTRY_BAS"
          elif [ -f "src/main.bas" ]; then
            found="src/main.bas"
          elif [ -f "main.bas" ]; then
            found="main.bas"
          else
            found="$(find . -type f -name '*.bas' | head -n1 || true)"
          fi
          [ -n "${found:-}" ] || { echo "No .BAS file found. Set env ENTRY_BAS or add a file."; exit 1; }
          echo "ENTRY_BAS=$found" >> "$GITHUB_ENV"

      - name: Compile BAS (Raspberry Pi, CLI only)
        run: |
          set -euo pipefail
          qb="$(cat qb64pe_path.txt)"
          [ -f "$ENTRY_BAS" ] || { echo "ENTRY_BAS not found: $ENTRY_BAS"; exit 1; }
          mkdir -p build
          "$qb" -x "$ENTRY_BAS" -o "build/${APP_NAME}-raspi"

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-raspi
          path: build/${{ env.APP_NAME }}-raspi
