name: Build QB64-PE Linux (source â†’ compile)

on:
  workflow_dispatch:      # lets you run it manually
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write       # needed to create a release / upload assets

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 1. Download latest source-code release
      # -------------------------------------------------
      - name: Get latest source release URL
        id: release
        run: |
          API_URL="https://api.github.com/repos/QB64-Phoenix-Edition/QB64pe/releases/latest"
          URL=$(curl -fsSL "$API_URL" \
                | jq -r '.assets[] | select(.name | contains("src") and endswith(".tar.gz")) | .browser_download_url' \
                | head -n1)
          echo "Source URL: $URL"
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Download source archive
        if: steps.release.outputs.url != ''
        run: |
          curl -fsSL -o qb64pe-src.tar.gz "${{ steps.release.outputs.url }}"

      - name: Extract source
        run: |
          mkdir -p qb64pe-src
          tar -xzf qb64pe-src.tar.gz -C qb64pe-src --strip-components=1
          ls -R qb64pe-src

      # -------------------------------------------------
      # 2. Compile using setup_lnx.sh
      # -------------------------------------------------
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgl1-mesa-dev libglu1-mesa-dev \
                                  libasound2-dev libpulse-dev libx11-dev libxi-dev \
                                  libxext-dev libxxf86vm-dev libxrandr-dev libxcursor-dev

      - name: Run setup_lnx.sh (CLI-only)
        working-directory: qb64pe-src
        run: |
          chmod +x ./setup_lnx.sh
          ./setup_lnx.sh -cli   # builds only the CLI version (no GUI)

      # -------------------------------------------------
      # 3. Verify the binary exists
      # -------------------------------------------------
      - name: Check compiled binary
        run: |
          BINARY="qb64pe-src/qb64pe"
          if [ ! -f "$BINARY" ]; then
            echo "qb64pe binary not found!"
            ls -la qb64pe-src/
            exit 1
          fi
          chmod +x "$BINARY"
          file "$BINARY"
          ./"$BINARY" -v || true   # just show version

      # -------------------------------------------------
      # 4. Upload as artifact (available for 90 days)
      # -------------------------------------------------
      - name: Upload qb64pe binary as artifact
        uses: actions/upload-artifact@v4
        with:
          name: qb64pe-linux-x64
          path: qb64pe-src/qb64pe
          if-no-files-found: error

      # -------------------------------------------------
      # 5. Create a GitHub Release with the binary (permanent)
      # -------------------------------------------------
      - name: Create Release & upload binary
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="linux-$(date +%Y%m%d-%H%M%S)"
          gh release create "$TAG" \
            --title "QB64-PE Linux CLI ${{ github.sha }}" \
            --notes "Automated build from source on $(date). Commit: ${{ github.sha }}" \
            qb64pe-src/qb64pe

          echo "Release created: $TAG"
          echo "Download it from: https://github.com/${{ github.repository }}/releases/tag/$TAG"
