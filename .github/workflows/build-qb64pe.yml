name: Build (QB64-PE prebuilt, CLI-only)
on:
  push:
    branches: [ main ]
  pull_request:
env:
  APP_NAME: MyProgram
  ENTRY_BAS: src/main.bas
  API_URL: https://api.github.com/repos/QB64-Phoenix-Edition/QB64pe/releases/latest
jobs:
  # -------------------- Ubuntu Linux x64 --------------------
  linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download prebuilt QB64-PE (Linux x64)
        run: |
          set -euo pipefail
          release="$(curl -fsSL "$API_URL")"
          url="$(printf '%s\n' "$release" \
            | grep -Eo '"browser_download_url": *"[^"]+"' \
            | sed -E 's/.*"([^"]+)"/\1/' \
            | grep -E '(qb64pe_lnx.*\.(tar\.gz|zip))$' \
            | head -n1)"
          [ -n "$url" ] || { echo "No Linux x64 asset found."; exit 1; }
          name="$(basename "$url")"
          curl -fsSL "$url" -o "$name"
          mkdir -p qb64pe
          case "$name" in
            *.zip) unzip -q "$name" -d qb64pe ;;
            *.tar.gz) tar -xzf "$name" -C qb64pe ;;
          esac
          qb="$(find qb64pe -type f -name qb64pe | head -n1)"
          [ -n "$qb" ] || { echo "qb64pe CLI not found"; exit 1; }
          chmod +x "$qb" || true
          echo "$qb" > qb64pe_path.txt
      - name: Detect ENTRY_BAS (*nix)
        run: |
          set -euo pipefail
          if [ -n "${ENTRY_BAS:-}" ] && [ -f "$ENTRY_BAS" ]; then
            found="$ENTRY_BAS"
          elif [ -f "src/main.bas" ]; then
            found="src/main.bas"
          elif [ -f "main.bas" ]; then
            found="main.bas"
          else
            found="$(find . -type f -name '*.bas' | head -n1 || true)"
          fi
          [ -n "${found:-}" ] || { echo "No .BAS file found. Set env ENTRY_BAS or add a file."; exit 1; }
          echo "ENTRY_BAS=$found" >> "$GITHUB_ENV"
      - name: Compile BAS (Linux x64, CLI only)
        run: |
          set -euo pipefail
          qb="$(cat qb64pe_path.txt)"
          [ -f "$ENTRY_BAS" ] || { echo "ENTRY_BAS not found: $ENTRY_BAS"; exit 1; }
          mkdir -p build
          "$qb" -x "$ENTRY_BAS" -o "build/${APP_NAME}-linux-x64"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-x64
          path: build/${{ env.APP_NAME }}-linux-x64
