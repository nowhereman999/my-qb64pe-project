name: Build QB64PE Binaries

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]  # Optional: Trigger on tags for releases

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: lnx
            ext: tar.gz
            setup: setup_lnx.sh
            arch_label: x64
          - os: windows-latest
            platform: win-x64
            ext: zip
            setup: ''
            arch_label: x64
          - os: macos-15-intel  # For x86_64/Intel
            platform: osx
            ext: tar.gz
            setup: setup_osx.command
            arch_label: x86_64
          - os: macos-latest  # For ARM64/M1+
            platform: osx
            ext: tar.gz
            setup: setup_osx.command
            arch_label: arm64
          - os: ubuntu-24.04-arm
            platform: lnx-aarch64
            ext: tar.gz
            setup: setup_lnx.sh
            arch_label: arm64-rpi
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get latest QB64PE release
        id: get_release
        uses: actions/github-script@v7
        with:
          script: |
            const response = await github.rest.repos.getLatestRelease({
              owner: 'QB64-Phoenix-Edition',
              repo: 'QB64pe'
            });
            const tag = response.data.tag_name;
            const version = tag.replace(/^v/, '');
            core.setOutput('tag', tag);
            core.setOutput('version', version);

      - name: Install Linux dependencies (if applicable)
        if: runner.os == 'Linux'
        run: |
          sudo apt update
          sudo apt install -y build-essential git libgl1-mesa-dev libglu1-mesa-dev libasound2-dev libpulse-dev freeglut3-dev libcurl4-openssl-dev clang lld

      - name: Set up QB64PE
        env:
          DOWNLOAD_URL: https://github.com/QB64-Phoenix-Edition/QB64pe/releases/download/${{ steps.get_release.outputs.tag }}/qb64pe_${{ matrix.platform }}-${{ steps.get_release.outputs.version }}.${{ matrix.ext }}
        run: |
          if [ '${{ runner.os }}' == 'Linux' ] || [ '${{ runner.os }}' == 'macOS' ]; then
            curl -L "$DOWNLOAD_URL" -o qb64pe.${{ matrix.ext }}
            tar xzf qb64pe.${{ matrix.ext }}
            cd qb64
            if [ -n "${{ matrix.setup }}" ]; then
              chmod +x ${{ matrix.setup }}
              ./${{ matrix.setup }}
            fi
            cd ..
          else  # Windows
            curl.exe -L -o qb64pe.zip "$env:DOWNLOAD_URL"
            powershell Expand-Archive qb64pe.zip -DestinationPath .
            # No setup for Windows
          fi

      - name: Compile program
        run: |
          cd qb64
          if [ '${{ runner.os }}' == 'Windows' ]; then
            .\qb64.exe -c ..\Hello.BAS
          else
            ./qb64 -c ../Hello.BAS
          fi
          cd ..

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: Hello-${{ matrix.os }}-${{ matrix.arch_label }}
          path: qb64/Hello*
          retention-days: 30  # Keep artifacts for 30 days

      - name: Create Release (optional, on tags)
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v2
        with:
          files: qb64/Hello*
          generate_release_notes: true
