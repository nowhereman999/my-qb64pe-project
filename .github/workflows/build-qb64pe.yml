name: Build (QB64-PE matrix)

on:
  push:
    branches: [ main ]
  pull_request:

env:
  APP_NAME: MyProgram             # change to your program name (no extension)
  ENTRY_BAS: src/main.bas         # change to your entry .BAS file path
  QB64PE_REPO: https://github.com/QB64-Phoenix-Edition/QB64pe.git

jobs:
  # -------- macOS Intel (x86_64) --------
  macos-intel:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - name: Clone QB64-PE
        run: git clone --depth=1 "$QB64PE_REPO" qb64pe
      - name: Build QB64-PE tool
        run: |
          cd qb64pe
          ./setup_osx.command
      - name: Compile BAS (macOS Intel)
        run: |
          ./qb64pe/qb64pe -x "$ENTRY_BAS" -o "build/${{ env.APP_NAME }}-macOS-Intel"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macOS-Intel
          path: build/${{ env.APP_NAME }}-macOS-Intel

  # -------- macOS Apple Silicon (arm64) --------
  macos-arm:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: Clone QB64-PE
        run: git clone --depth=1 "$QB64PE_REPO" qb64pe
      - name: Build QB64-PE tool
        run: |
          cd qb64pe
          ./setup_osx.command
      - name: Compile BAS (macOS ARM)
        run: |
          ./qb64pe/qb64pe -x "$ENTRY_BAS" -o "build/${{ env.APP_NAME }}-macOS-ARM"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-macOS-ARM
          path: build/${{ env.APP_NAME }}-macOS-ARM

  # -------- Ubuntu Linux x86_64 --------
  linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps (OpenGL/ALSA/etc.)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git \
            libgl1-mesa-dev libglu1-mesa-dev freeglut3-dev \
            libx11-dev libxext-dev libxi-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libasound2-dev libpulse-dev libudev-dev
      - name: Clone QB64-PE
        run: git clone --depth=1 "$QB64PE_REPO" qb64pe
      - name: Build QB64-PE tool
        run: |
          cd qb64pe
          ./setup_lnx.sh
      - name: Compile BAS (Linux x64)
        run: |
          ./qb64pe/qb64pe -x "$ENTRY_BAS" -o "build/${{ env.APP_NAME }}-linux-x64"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-linux-x64
          path: build/${{ env.APP_NAME }}-linux-x64

  # -------- Windows x64 --------

windows-x64:
  runs-on: windows-latest
  steps:
    - uses: actions/checkout@v4

    # Ensure 7-Zip is available (needed if the asset is .7z)
    - name: Install 7-Zip
      shell: pwsh
      run: |
        choco install -y 7zip
        $env:Path += ";C:\Program Files\7-Zip"
        7z i | Out-Null

    - name: Download QB64-PE (Windows) asset via API (no gh)
      shell: pwsh
      env:
        API: https://api.github.com/repos/QB64-Phoenix-Edition/QB64pe/releases/latest
      run: |
        # Grab latest release payload
        $release = Invoke-RestMethod $env:API

        # Try to find a Windows asset: qb64pe_win-*.7z or .zip
        $asset = $release.assets | Where-Object {
          $_.name -match '^qb64pe_win-(x64|arm64).*\.(7z|zip)$'
        } | Select-Object -First 1

        if (-not $asset) {
          throw "No Windows asset (qb64pe_win-*.7z/.zip) found in latest release."
        }

        Write-Host "Downloading $($asset.name)"
        $out = if ($asset.name -match '\.7z$') { 'qb64pe.7z' } else { 'qb64pe.zip' }
        Invoke-WebRequest $asset.browser_download_url -OutFile $out

        New-Item -ItemType Directory -Force -Path qb64pe | Out-Null
        if (Test-Path qb64pe.7z) {
          7z x qb64pe.7z -oqb64pe | Out-Null
        } else {
          Expand-Archive qb64pe.zip -DestinationPath qb64pe -Force
        }

        # Locate qb64pe.exe in the extracted tree (directory name can vary)
        $exe = Get-ChildItem -Path qb64pe -Recurse -Filter qb64pe.exe -File | Select-Object -First 1
        if (-not $exe) { throw "qb64pe.exe not found after extraction." }
        "$($exe.FullName)" | Out-File -FilePath qb64pe_path.txt -Encoding ascii

    - name: Compile BAS (Windows)
      shell: pwsh
      env:
        APP_NAME: ${{ env.APP_NAME }}
        ENTRY_BAS: ${{ env.ENTRY_BAS }}
      run: |
        $qb = Get-Content qb64pe_path.txt -Raw
        if (-not (Test-Path $env:ENTRY_BAS)) {
          throw "ENTRY_BAS not found: $env:ENTRY_BAS (check your repo path)."
        }
        New-Item -ItemType Directory -Force -Path build | Out-Null
        & $qb -x "$env:ENTRY_BAS" -o "build\${env:APP_NAME}-windows.exe"

    - uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-windows
        path: build/${{ env.APP_NAME }}-windows.exe
          
  # -------- Raspberry Pi (self-hosted) --------
  # Set up a self-hosted runner on your Pi (labels: self-hosted, Linux, ARM64 or ARM)
  raspberry-pi:
    if: ${{ always() }}  # let it try if you have a Pi runner; otherwise it will be skipped
    runs-on: [self-hosted, Linux, ARM64]
    steps:
      - uses: actions/checkout@v4
      - name: Install deps (may need sudo)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git \
            libgl1-mesa-dev libglu1-mesa-dev freeglut3-dev \
            libx11-dev libxext-dev libxi-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libasound2-dev libpulse-dev libudev-dev
      - name: Clone QB64-PE
        run: git clone --depth=1 "$QB64PE_REPO" qb64pe
      - name: Build QB64-PE tool (Pi)
        run: |
          cd qb64pe
          ./setup_lnx.sh
      - name: Compile BAS (Pi native)
        run: |
          ./qb64pe/qb64pe -x "$ENTRY_BAS" -o "build/${{ env.APP_NAME }}-raspi"
      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.APP_NAME }}-raspi
          path: build/${{ env.APP_NAME }}-raspi
