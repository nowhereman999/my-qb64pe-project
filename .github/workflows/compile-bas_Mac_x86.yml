name: Compile QB64-PE (macOS x86)

on:
  push:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  pull_request:
    paths:
      - 'BASIC-To-6809_Source_Code/*.bas'
      - 'BASIC-To-6809_Source_Code/*.BAS'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.bas'
      - 'BASIC-To-6809_Source_Code/IDE/SDECB.BAS'
  workflow_dispatch:
    inputs:
      bas_paths:
        description: 'Comma-separated .bas file paths (relative to repo root)'
        required: false
        type: string

jobs:
  build:
    runs-on: macos-13
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify QB64-PE x86 setup
        run: |
          QB64PE_DIR="$GITHUB_WORKSPACE/tools/qb64pe_mac_x86"
          cd "$QB64PE_DIR"
          [ -f "./qb64pe" ] || { echo "qb64pe missing!"; exit 1; }
          [ -d "./internal" ] || { echo "internal/ missing!"; exit 1; }
          [ -f "./Makefile" ] || { echo "Makefile missing!"; exit 1; }

      - name: Make qb64pe executable
        run: |
          QB64PE_DIR="$GITHUB_WORKSPACE/tools/qb64pe_mac_x86"
          chmod +x "$QB64PE_DIR/qb64pe"

      - name: Install Xcode Command Line Tools
        run: xcode-select --install || true

      - name: Compile selected .bas files
        id: compile
        run: |
          QB64PE_DIR="$GITHUB_WORKSPACE/tools/qb64pe_mac_x86"
          ARTIFACT_DIR="$GITHUB_WORKSPACE/artifacts"
          mkdir -p "$ARTIFACT_DIR"

          if [ -n "${{ inputs.bas_paths }}" ]; then
            IFS=',' read -r -a FILES <<< "${{ inputs.bas_paths }}"
          else
            # --- Bash 3.2 compatible way to get root .bas files ---
            ROOT_DIR="$GITHUB_WORKSPACE/BASIC-To-6809_Source_Code"
            ROOT_FILES=""
            for f in "$ROOT_DIR"/*; do
              if [[ -f "$f" && ("$f" == *.bas || "$f" == *.BAS) ]]; then
                rel_path="${f#$GITHUB_WORKSPACE/}"
                ROOT_FILES="$ROOT_FILES $rel_path"
              fi
            done
            ROOT_FILES="${ROOT_FILES# }"  # trim leading space

            # --- Add SDECB.bas (only once, case-insensitive) ---
            SDECB_PATH=""
            if [ -f "$ROOT_DIR/IDE/SDECB.bas" ]; then
              SDECB_PATH="BASIC-To-6809_Source_Code/IDE/SDECB.bas"
            elif [ -f "$ROOT_DIR/IDE/SDECB.BAS" ]; then
              SDECB_PATH="BASIC-To-6809_Source_Code/IDE/SDECB.BAS"
            fi

            # Combine
            FILES="$ROOT_FILES"
            [ -n "$SDECB_PATH" ] && FILES="$FILES $SDECB_PATH"
          fi

          # Convert space-separated string to array
          IFS=' ' read -r -a FILE_ARRAY <<< "$FILES"

          # Remove duplicates
          UNIQUE=""
          for f in "${FILE_ARRAY[@]}"; do
            if [[ "$UNIQUE" != *" $f "* ]]; then
              UNIQUE="$UNIQUE $f "
            fi
          done
          UNIQUE="${UNIQUE% }"  # trim trailing space
          IFS=' ' read -r -a FILE_ARRAY <<< "$UNIQUE"

          if [ ${#FILE_ARRAY[@]} -eq 0 ]; then
            echo "No .bas files to compile."
            echo "executables=" >> "$GITHUB_OUTPUT"
            echo "compiled_count=0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Compiling ${#FILE_ARRAY[@]} file(s):"
          printf ' - %s\n' "${FILE_ARRAY[@]}"

          EXECUTABLES=""
          COUNT=0
          for file in "${FILE_ARRAY[@]}"; do
            file=$(echo "$file" | xargs)
            [[ ! "$file" =~ \.[bB][aA][sS]$ ]] && continue

            rel_dir=$(dirname "$file")
            filename=$(basename "$file")
            base="${filename%.*}"
            full_dir="$GITHUB_WORKSPACE/$rel_dir"

            echo "Compiling (in $rel_dir): $filename â†’ $base"
            cd "$full_dir"

            if ! "$QB64PE_DIR/qb64pe" -x "$filename" -o "$base"; then
              LOG_PATH="$QB64PE_DIR/internal/temp/compilelog.txt"
              echo "=== COMPILATION ERROR ==="
              if [ -f "$LOG_PATH" ]; then
                echo "Contents of $LOG_PATH:"
                cat "$LOG_PATH"
              else
                echo "compilelog.txt not found."
              fi
              echo "========================"
              exit 1
            fi

            cp "$base" "$ARTIFACT_DIR/$base"
            rm -f "$base"
            EXECUTABLES="$EXECUTABLES $base"
            COUNT=$((COUNT + 1))
          done

          EXECUTABLES="${EXECUTABLES# }"
          echo "executables=$EXECUTABLES" >> "$GITHUB_OUTPUT"
          echo "compiled_count=$COUNT" >> "$GITHUB_OUTPUT"

      - name: Remove quarantine attribute
        if: steps.compile.outputs.compiled_count > 0
        run: |
          for exe in ${{ steps.compile.outputs.executables }}; do
            xattr -dr com.apple.quarantine "$GITHUB_WORKSPACE/artifacts/$exe" 2>/dev/null || true
          done

      - name: Create zip archive
        if: steps.compile.outputs.compiled_count > 0
        run: |
          cd "$GITHUB_WORKSPACE/artifacts"
          zip qb64pe_mac_x86_executables.zip ${{ steps.compile.outputs.executables }}
          echo "Zipped ${{ steps.compile.outputs.compiled_count }} executable(s)"

      - name: Upload artifact
        if: steps.compile.outputs.compiled_count > 0
        uses: actions/upload-artifact@v4
        with:
          name: qb64pe-mac-x86-executables
          path: ${{ github.workspace }}/artifacts/qb64pe_mac_x86_executables.zip
          retention-days: 30

      - name: Job summary
        if: success()
        run: |
          echo "## QB64-PE macOS x86 Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "Compiled ${{ steps.compile.outputs.compiled_count }} program(s):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for exe in ${{ steps.compile.outputs.executables }}; do
            echo "- \`$exe\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Download the zip from **Artifacts** below" >> $GITHUB_STEP_SUMMARY